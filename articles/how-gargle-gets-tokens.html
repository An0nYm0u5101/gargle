<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How gargle gets tokens • gargle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How gargle gets tokens">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gargle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/how-gargle-gets-tokens.html">How gargle gets tokens</a>
    </li>
    <li>
      <a href="../articles/gargle-auth-in-client-package.html">How to use gargle for auth in a client package</a>
    </li>
    <li>
      <a href="../articles/request-helper-functions.html">Request Helper Functions</a>
    </li>
    <li>
      <a href="../articles/articles/managing-tokens-securely.html">Managing tokens securely</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/gargle">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How gargle gets tokens</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/master/vignettes/how-gargle-gets-tokens.Rmd"><code>vignettes/how-gargle-gets-tokens.Rmd</code></a></small>
      <div class="hidden name"><code>how-gargle-gets-tokens.Rmd</code></div>

    </div>

    
    
<p>This vignette explains the purpose and usage of <code><a href="../reference/token_fetch.html">token_fetch()</a></code> and the functions it subsequently calls. The goal of <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is to secure a token for use in downstream requests.</p>
<p>The target audience is someone writing an R package to wrap a Google API. It is expected that those developers provide regular end-users with a friendlier and more automatic workflow that usually “just works”. We give some design suggestions for wrapper packages, which is covered in more depth in <a href="https://gargle.r-lib.org/articles/gargle-auth-in-client-package.html">How to use gargle for auth in a client package</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(gargle)</a></code></pre></div>
<div id="token_fetch" class="section level2">
<h2 class="hasAnchor">
<a href="#token_fetch" class="anchor"></a><code><a href="../reference/token_fetch.html">token_fetch()</a></code>
</h2>
<p><code><a href="../reference/token_fetch.html">token_fetch()</a></code> is a rather magical function for getting a token. The goal is to make auth relatively painless for users, while allowing developers and power users to take control when and if they need to. Most users will presumably interact with <code><a href="../reference/token_fetch.html">token_fetch()</a></code> only in an indirect way, mediated through an API wrapper package. That is not because the interface of <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is unfriendly – it’s very flexible! It’s because most general-purpose wrappers should be catching and handling the token returned by <code><a href="../reference/token_fetch.html">token_fetch()</a></code>, as opposed to forcing users to explicitly acquire and manage their tokens. The objective of <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is to allow package developers to not worry about all the different ways of getting a token.</p>
<p>The signature of <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is very simple and, therefore, not very informative:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(scopes, ...)</a></code></pre></div>
<p>Under the hood, <code><a href="../reference/token_fetch.html">token_fetch()</a></code> calls a sequence of much more specific credential functions, each wrapped in a <code><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch()</a></code> and returning <code>NULL</code> if unsuccessful. The only formal argument these functions have in common is <code>scopes</code>, with the rest being passed via <code>...</code>.</p>
<p>This gives a sense of the credential functions and reflects the order in which they are called:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(<span class="kw"><a href="../reference/cred_funs_list.html">cred_funs_list</a></span>())</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] "credentials_service_account" "credentials_app_default"    </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; [3] "credentials_gce"             "credentials_user_oauth2"</span></a></code></pre></div>
<p>It is possible to manipulate this registry of functions. The help for <code><a href="../reference/cred_funs_list.html">cred_funs_list()</a></code> is a good place to learn more.</p>
<p>From now on, however, we assume you’re working with the default registry that ships with gargle.</p>
<p>Note also that these credential functions are exported and can be called directly.</p>
</div>
<div id="get-verbose-output" class="section level2">
<h2 class="hasAnchor">
<a href="#get-verbose-output" class="anchor"></a>Get verbose output</h2>
<p>To see more information about what gargle is up to, set the option <code>gargle_quiet</code> to <code>FALSE</code>. Read more in the docs for <code><a href="../reference/gargle_options.html">gargle_quiet()</a></code>.</p>
</div>
<div id="credentials_service_account" class="section level2">
<h2 class="hasAnchor">
<a href="#credentials_service_account" class="anchor"></a><code><a href="../reference/credentials_service_account.html">credentials_service_account()</a></code>
</h2>
<p>The first function tried is <code><a href="../reference/credentials_service_account.html">credentials_service_account()</a></code>. Here’s how a call to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> with service account inputs plays out:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(<span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>, <span class="dt">path =</span> <span class="st">"/path/to/your/service-account.json"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># leads to this call:</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw"><a href="../reference/credentials_service_account.html">credentials_service_account</a></span>(</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="dt">path =</span> <span class="st">"/path/to/your/service-account.json"</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">)</a></code></pre></div>
<p>The <code>scopes</code> are often provided by the API wrapper function that is mediating the calls to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> and <code>credential_service_account()</code>. The <code>path</code> argument is presumably coming from the user. It is treated as a JSON representation of service account credentials, in any form that is acceptable to <code><a href="https://www.rdocumentation.org/packages/jsonlite/topics/fromJSON">jsonlite::fromJSON()</a></code>. In the above example, that is a file path, but it could also be a JSON string. If there is no named <code>path</code> argument or if it can’t be parsed as a service account credential, we fail and <code><a href="../reference/token_fetch.html">token_fetch()</a></code>’s execution moves on to the next function in the registry.</p>
<p>Here is some Google documentation about service accounts:</p>
<ul>
<li><a href="https://cloud.google.com/iam/docs/understanding-service-accounts">Cloud Identity and Access Management &gt; Understanding service accounts</a></li>
</ul>
<p>For R users, a service account is a great option for credentials that will be used in a script or application running remotely or in an unattended fashion. In particular, this is a better approach than trying to move OAuth2 credentials from one machine to another. For example, a service account is the preferred method of auth when testing and documenting a package on a continuous integration service.</p>
<p>The JSON key file must be managed securely. In particular, it should not be kept in, e.g., a GitHub repository (unless it is encrypted). The encryption strategy used by gargle and other packages is described in the article <a href="https://gargle.r-lib.org/articles/articles/managing-tokens-securely.html">Managing tokens securely</a>.</p>
</div>
<div id="credentials_app_default" class="section level2">
<h2 class="hasAnchor">
<a href="#credentials_app_default" class="anchor"></a><code><a href="../reference/credentials_app_default.html">credentials_app_default()</a></code>
</h2>
<p>The second function tried is <code><a href="../reference/credentials_app_default.html">credentials_app_default()</a></code>. Here’s how a call to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> might work:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(<span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># credentials_service_account() fails because no `path`,</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co"># which leads to this call:</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw"><a href="../reference/credentials_app_default.html">credentials_app_default</a></span>(</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">)</a></code></pre></div>
<p><code><a href="../reference/credentials_app_default.html">credentials_app_default()</a></code> loads credentials from a file identified via a search strategy known as <a href="https://cloud.google.com/docs/authentication/production#providing_credentials_to_your_application">Application Default Credentials (ADC)</a>. The credentials themselves are conventional service account or user credentials that happen to be stored in a pre-ordained location and format.</p>
<p>The hope is to make auth “just work” for someone working on Google-provided infrastructure or who has used Google tooling to get started. A sequence of paths is consulted, which we describe here, with some abuse of notation. ALL_CAPS represents the value of an environment variable and <code>%||%</code> is used in the spirit of a <a href="https://en.wikipedia.org/wiki/Null_coalescing_operator">null coalescing operator</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">GOOGLE_APPLICATION_CREDENTIALS</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">CLOUDSDK_CONFIG<span class="op">/</span>application_default_credentials.json</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># on Windows:</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">(APPDATA <span class="op">%||%</span><span class="st"> </span>SystemDrive <span class="op">%||%</span><span class="st"> </span>C<span class="op">:</span>)\gcloud\application_default_credentials.json</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># on not-Windows:</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="op">~</span><span class="er">/</span>.config<span class="op">/</span>gcloud<span class="op">/</span>application_default_credentials.json</a></code></pre></div>
<p>If the above search successfully identifies a JSON file, it is parsed and ingested either as a service account token or an OAuth2 user credential. In the case of an OAuth2 credential, the requested <code>scopes</code> must also meet certain criteria. Note that this will NOT work for OAuth2 credentials initiated by gargle. The storage of OAuth2 user credentials as JSON is unique to certain Google tools – possibly just the <a href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login"><code>gcloud</code> CLI</a> – and should probably be regarded as deprecated. It is probably best to use ADC with a service account. If this quest is unsuccessful, we fail and <code><a href="../reference/token_fetch.html">token_fetch()</a></code>’s execution moves on to the next function in the registry.</p>
<p>The main takeaway lesson:</p>
<ul>
<li>You can make auth “just work” by storing a service account token JSON key file at one of the filepaths listed above. It will be automagically discovered when <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is called with only the <code>scopes</code> argument specified.</li>
</ul>
<p>Again, remember that the JSON key file must be managed securely and should NOT live in a directory that syncs to the cloud.</p>
</div>
<div id="credentials_gce" class="section level2">
<h2 class="hasAnchor">
<a href="#credentials_gce" class="anchor"></a><code><a href="../reference/credentials_gce.html">credentials_gce()</a></code>
</h2>
<p>The third function tried is <code><a href="../reference/credentials_gce.html">credentials_gce()</a></code>. Here’s how a call to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> might work:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(<span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co"># or perhaps</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(<span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>, <span class="dt">service_account =</span> <span class="op">&lt;</span>SERVICE_ACCOUNT<span class="op">&gt;</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># credentials_service_account() fails because no `path`,</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># credentials_app_default() fails because no ADC found,</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co"># which leads to one of these calls:</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="kw"><a href="../reference/credentials_gce.html">credentials_gce</a></span>(</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  <span class="dt">service_account =</span> <span class="st">"default"</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co"># or</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="kw"><a href="../reference/credentials_gce.html">credentials_gce</a></span>(</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  <span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  <span class="dt">service_account =</span> <span class="op">&lt;</span>SERVICE_ACCOUNT<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">)</a></code></pre></div>
<p><code><a href="../reference/credentials_gce.html">credentials_gce()</a></code> retrieves service account credentials from a metadata service that is specific to virtual machine instances running on Google Cloud Engine (GCE). Basically, if you have to ask what this is about, this is not the auth method for you. Let us move on.</p>
</div>
<div id="credentials_user_oauth2" class="section level2">
<h2 class="hasAnchor">
<a href="#credentials_user_oauth2" class="anchor"></a><code><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2()</a></code>
</h2>
<p>The fourth and final function tried is <code><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2()</a></code>. Here’s how a call to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> might work:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/token_fetch.html">token_fetch</a></span>(<span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co"># credentials_service_account() fails because no `path`,</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># credentials_app_default() fails because no ADC found,</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># credentials_gce() fails because not on GCE,</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># which leads to this call:</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="kw"><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2</a></span>(</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  <span class="dt">scopes =</span> <span class="op">&lt;</span>SCOPES<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  <span class="dt">app =</span> <span class="kw"><a href="../reference/gargle_app.html">gargle_app</a></span>(),</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  <span class="dt">package =</span> <span class="st">"gargle"</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">)</a></code></pre></div>
<p><code><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2()</a></code> is where the vast majority of users will end up. This is the function that choreographs the traditional “OAuth dance” in the browser. User credentials are cached locally, at the user levels, by default. Therefore, after first use, there are flows in which gargle can determine unequivocally that it already has a suitable token on hand and can load (and possibly refresh) it, without additional user intervention.</p>
<p>The <code>scopes</code>, <code>app</code>, and <code>package</code> are often provided by the API wrapper function that is mediating the calls to <code><a href="../reference/token_fetch.html">token_fetch()</a></code>. In particular, <strong>no one</strong> should be using the OAuth app returned by <code><a href="../reference/gargle_app.html">gargle_app()</a></code> for anything other than experimentation. The wrapper package should use its own app or help the user to provide their own. The wrapper package would presumably also declare itself as the package requesting a token (this is used in messages). So here’s how a call to <code><a href="../reference/token_fetch.html">token_fetch()</a></code> and <code><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2()</a></code> might look when initiated from <code>THINGY_auth()</code>, a function in the fictional thingyr wrapper package:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># user initiates auth or does something that triggers it indirectly</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">THINGY_auth</span>()</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># which then calls</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/token_fetch.html">token_fetch</a></span>(</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="dt">scopes  =</span> <span class="op">&lt;</span>SCOPES_NEEDED_FOR_THE_THINGY_API<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="dt">app     =</span> <span class="kw">thingy_app</span>(),</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="dt">package =</span> <span class="st">"thingyr"</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co"># which leads to this call:</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw"><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2</a></span>(</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  <span class="dt">scopes  =</span> <span class="op">&lt;</span>SCOPES_NEEDED_FOR_THE_THINGY_API<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">  <span class="dt">app     =</span> <span class="kw">thingy_app</span>(),</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">  <span class="dt">package =</span> <span class="st">"thingyr"</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">)</a></code></pre></div>
<p>What happens now? How do we get to that happy place where the user is not constantly bugged about auth?</p>
<p>First, let’s define “suitable”, i.e. what it means to find a matching token in the cache. <code><a href="../reference/credentials_user_oauth2.html">credentials_user_oauth2()</a></code> is a thin wrapper around <code><a href="../reference/gargle2.0_token.html">gargle2.0_token()</a></code> which is the constructor for the <code><a href="../reference/Gargle-class.html">gargle::Gargle2.0</a></code> class used to hold an OAuth2 token. And that call might look something like this (simplified for communication purposes):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/gargle2.0_token.html">gargle2.0_token</a></span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="dt">email   =</span> <span class="kw"><a href="../reference/gargle_options.html">gargle_oauth_email</a></span>(),</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="dt">app     =</span> <span class="kw">thingy_app</span>(),</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  <span class="dt">package =</span> <span class="st">"thingyr"</span>,</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="dt">scope   =</span> <span class="op">&lt;</span>SCOPES_NEEDED_FOR_THE_THINGY_API<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="dt">cache   =</span> <span class="kw"><a href="../reference/gargle_options.html">gargle_oauth_cache</a></span>()</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">)</a></code></pre></div>
<p>gargle looks in the cache specified by <code><a href="../reference/gargle_options.html">gargle_oauth_cache()</a></code> for a token that has these scopes, this app, and the Google identity specified by <code>email</code>. By default <code>email</code> is <code>NA</code>, so we might find one or more tokens that have the necessary scopes and app. In that case, gargle reveals the <code>email</code> associated with the matching token(s) and asks the user for explicit instructions about how to proceed. That looks something like this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">The thingyr package is requesting access to your Google account. Select a pre<span class="op">-</span>authorised account or enter <span class="st">'0'</span> to obtain a new token. Press Esc<span class="op">/</span>Ctrl <span class="op">+</span><span class="st"> </span>C to abort.</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="dv">1</span><span class="op">:</span><span class="st"> </span>janedoe_personal<span class="op">@</span>gmail.com</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="dv">2</span><span class="op">:</span><span class="st"> </span>janedoe<span class="op">@</span>example.com</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="dv">3</span><span class="op">:</span><span class="st"> </span>janedoe_work<span class="op">@</span>gmail.com</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">Selection<span class="op">:</span><span class="st"> </span><span class="dv">3</span></a></code></pre></div>
<p>If none of the tokens have the right scopes and app (or if the user declines to use a pre-existing tokens), we head to the browser to initiate OAuth2 flow <em>de novo</em>.</p>
<p>A user can reduce the need for interaction by passing the target <code>email</code> to <code>thingy_auth()</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">drive_auth</span>(<span class="dt">email =</span> <span class="st">"janedoe_work@gmail.com"</span>)</a></code></pre></div>
<p>or by setting the <code>gargle_oauth_email</code> to a specific identity or to <code>TRUE</code>. A value of <code>TRUE</code> means that gargle is allowed to use a matching token whenever there is exactly one match.</p>
<p>The elevated status of <code>email</code> for <code><a href="../reference/Gargle-class.html">gargle::Gargle2.0</a></code> tokens is motivated by the fact that many of us have multiple Google identities and need them to be very prominent when working with Google APIs. This is one of the main motivations for <code><a href="../reference/Gargle-class.html">gargle::Gargle2.0</a></code>, which extends <code><a href="https://www.rdocumentation.org/packages/httr/topics/Token-class">httr::Token2.0</a></code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#token_fetch"><code><a href="--/reference/token_fetch-html">token_fetch()</a></code></a></li>
      <li><a href="#get-verbose-output">Get verbose output</a></li>
      <li><a href="#credentials_service_account"><code><a href="--/reference/credentials_service_account-html">credentials_service_account()</a></code></a></li>
      <li><a href="#credentials_app_default"><code><a href="--/reference/credentials_app_default-html">credentials_app_default()</a></code></a></li>
      <li><a href="#credentials_gce"><code><a href="--/reference/credentials_gce-html">credentials_gce()</a></code></a></li>
      <li><a href="#credentials_user_oauth2"><code><a href="--/reference/credentials_user_oauth2-html">credentials_user_oauth2()</a></code></a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://jennybryan.org">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
