<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auth when using R in the browser • gargle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Auth when using R in the browser">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gargle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/articles/managing-tokens-securely.html">Managing tokens securely</a>
    </li>
    <li>
      <a href="../articles/auth-from-web.html">Auth when using R in the browser</a>
    </li>
    <li>
      <a href="../articles/gargle-auth-in-client-package.html">How to use gargle for auth in a client package</a>
    </li>
    <li>
      <a href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    </li>
    <li>
      <a href="../articles/how-gargle-gets-tokens.html">How gargle gets tokens</a>
    </li>
    <li>
      <a href="../articles/non-interactive-auth.html">Non-interactive auth</a>
    </li>
    <li>
      <a href="../articles/request-helper-functions.html">Request helper functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/gargle">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Auth when using R in the browser</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/master/vignettes/auth-from-web.Rmd"><code>vignettes/auth-from-web.Rmd</code></a></small>
      <div class="hidden name"><code>auth-from-web.Rmd</code></div>

    </div>

    
    
<p>If you are working with R in a web-based context, like <a href="https://rstudio.com/products/rstudio/download-server/">RStudio Server</a> or <a href="https://rstudio.cloud">Cloud</a>, your experience of browser-based auth flows will be different from those using R, directly in the Console or through an IDE. You need to use <strong>out-of-band authentication</strong>, sometimes denoted “oob”. After the usual auth dance, instead of seeing “authentication successful, return to R!”, you are presented with an authorization code to copy and paste back into your R session.</p>
<p>The need to use oob auth can sometimes be detected automatically. For example, oob auth is always used when the httpuv package is not installed. However, gargle and httr currently fail to detect some other situations where oob is necessary. In these case, the user needs to recognize the situation and explicitly request oob auth.</p>
<p>Here’s a typical presentation of this problem: during auth, you are redirected to localhost on port 1410 and receive an error along these lines:</p>
<pre><code>Chrome: This site can't be reached; localhost refused to connect.
Firefox: Unable to connect; can't establish a connection.</code></pre>
<p>This is a sign that you need to explicitly request oob auth.</p>
<p>This article describes how to do so in a package that uses gargle for auth, which includes:</p>
<ul>
<li>
<a href="https://bigrquery.r-dbi.org">bigrquery</a> (&gt;= v1.2.0)</li>
<li>
<a href="https://googledrive.tidyverse.org">googledrive</a> (&gt;= v1.0.0)</li>
<li>
<a href="https://gmailr.r-lib.org">gmailr</a> (&gt;= v1.0.0)</li>
<li>
<a href="https://googlesheets4.tidyverse.org">googlesheets4</a> <em>GitHub only</em>
</li>
<li>
<a href="https://github.com/andrie/gcalendr">gcalendr</a> <em>GitHub only</em>
</li>
</ul>
<div id="request-oob-auth-in-the-pkg_auth-call" class="section level2">
<h2 class="hasAnchor">
<a href="#request-oob-auth-in-the-pkg_auth-call" class="anchor"></a>Request oob auth in the <code>PKG_auth()</code> call</h2>
<p>These packages aim to make auth “just work” for most users, i.e. it’s automatically triggered upon first need. However, it is always possible to initiate auth yourself, which gives you the opportunity to specify non-default values of certain parameters. Here’s how you request oob auth, using googledrive as an example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googledrive)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">drive_auth</span>(<span class="dt">use_oob =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co"># now carry on with your work</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">drive_find</span>(<span class="dt">n_max =</span> <span class="dv">5</span>)</a></code></pre></div>
<p>This code is tailored to an interactive session and assumes that a user is present to respond. If you <em>also</em> need to setup a token for non-interactive use, see the article <a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">Non-interactive auth</a>. A key point is that oob auth is relevant to how you <em>initially</em> obtain a token. It is orthogonal to downstream use and refreshing. So it is possible that you need to attend to both!</p>
</div>
<div id="set-the-gargle_oob_default-option" class="section level2">
<h2 class="hasAnchor">
<a href="#set-the-gargle_oob_default-option" class="anchor"></a>Set the <code>gargle_oob_default</code> option</h2>
<p>If you know that you <em>always</em> want to use oob auth, as a user or within a project, the best way to express this is to set the <code>gargle_oob_default</code> option.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="dt">gargle_oob_default =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>This code could appear at the top of a script, in a setup chunk for <code>.Rmd</code>, or in a Shiny app. But it probably makes even more sense in a <code>.Rprofile</code> startup file, at the user- or project-level.</p>
<p>Once that option has been set, it is honoured by downstream calls to <code>PKG_auth()</code>, explicit or implicit, because the default behaviour of <code>use_oob</code> is to consult the option:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">drive_auth &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">email =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oauth_email</a></span>(),</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                       <span class="dt">path =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                       <span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                       <span class="dt">cache =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oauth_cache</a></span>(),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">                       <span class="dt">use_oob =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oob_default</a></span>(),</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">                       <span class="dt">token =</span> <span class="ot">NULL</span>) {...}</a></code></pre></div>
</div>
<div id="but-i-didnt-need-oob-yesterday" class="section level2">
<h2 class="hasAnchor">
<a href="#but-i-didnt-need-oob-yesterday" class="anchor"></a>But I didn’t need oob yesterday!</h2>
<p>Sometimes the usual oauth web flow suddenly stops working for people working directly with R (so NOT via the browser) and they use oob auth to get unstuck again. What’s going on in this case?</p>
<p>The initial error looks something like this:</p>
<pre><code>createTcpServer: address already in use
Error in httpuv::startServer(use$host, use$port, list(call = listen)) : 
  Failed to create server</code></pre>
<p>It’s characteristic of some other process sitting on port 1410, which is what httr is trying to use for auth.</p>
<p>It’s true that using oob auth is a workaround. But oob auth is, frankly, more clunky, so why use if you don’t have to? Here are ways to fix.</p>
<ul>
<li>Restart your system. This will almost certainly kill the offending process, which is usually a zombie process.</li>
<li>Hunt down the offending process, verify it looks expendable, and kill it.</li>
</ul>
<p>On *nix-y systems, use <code>lsof</code> to get the process ID:</p>
<pre><code>sudo lsof -i :1410</code></pre>
<p>The output will look something like this:</p>
<pre><code>COMMAND   PID  USER   FD   TYPE            DEVICE SIZE/OFF NODE NAME
R       16664 jenny   20u  IPv4 0x63761a50856c65f      0t0  TCP localhost:hiq (LISTEN)</code></pre>
<p>In this case, as is typical, this is a zombie R process and I feel confident killing it. The process ID is listed there as PID. Note that and kill the process, like so, filling in the PID you found:</p>
<pre><code>kill -9 &lt;PID&gt;</code></pre>
<p>So, to be clear, in this example, the command would be:</p>
<pre><code>kill -9 16664</code></pre>
<p>The normal, non-oob auth web flow should work again now.</p>
</div>
<div id="further-reading" class="section level2">
<h2 class="hasAnchor">
<a href="#further-reading" class="anchor"></a>Further reading</h2>
<p><a href="https://support.rstudio.com/hc/en-us/articles/217952868-Generating-OAuth-tokens-from-a-server">Generating OAuth tokens for a server using httr</a> covers some of the same ground, although for the httr package. gargle provides a Google-specific interface to httr. gargle first consults the <code>gargle_oob_default</code> option and, if that is undefined, also consults the <code>httr_oob_default</code> option.</p>
<p>If you’re creating content to be deployed (for example on <a href="https://www.shinyapps.io">shinyapps.io</a> or <a href="https://www.rstudio.com/products/connect/">RStudio Connect</a>), you will also need to consider how the <a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">deployed content will authenticate non-interactively</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#request-oob-auth-in-the-pkg_auth-call">Request oob auth in the <code>PKG_auth()</code> call</a></li>
      <li><a href="#set-the-gargle_oob_default-option">Set the <code>gargle_oob_default</code> option</a></li>
      <li><a href="#but-i-didnt-need-oob-yesterday">But I didn’t need oob yesterday!</a></li>
      <li><a href="#further-reading">Further reading</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://jennybryan.org">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
