<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to use gargle for auth in a client package • gargle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to use gargle for auth in a client package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gargle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/articles/managing-tokens-securely.html">Managing tokens securely</a>
    </li>
    <li>
      <a href="../articles/gargle-auth-in-client-package.html">How to use gargle for auth in a client package</a>
    </li>
    <li>
      <a href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    </li>
    <li>
      <a href="../articles/how-gargle-gets-tokens.html">How gargle gets tokens</a>
    </li>
    <li>
      <a href="../articles/request-helper-functions.html">Request helper functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/gargle">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How to use gargle for auth in a client package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/master/vignettes/gargle-auth-in-client-package.Rmd"><code>vignettes/gargle-auth-in-client-package.Rmd</code></a></small>
      <div class="hidden name"><code>gargle-auth-in-client-package.Rmd</code></div>

    </div>

    
    
<p>gargle provides common infrastructure for use with Google APIs. This vignette describes one possible design for using gargle to deal with auth, in a client package that provides a high-level wrapper for a specific API.</p>
<p>There are frequent references to (the development version of) <a href="https://googledrive.tidyverse.org">googledrive</a>, which is a functioning test bed. The released version of googledrive already presents a very similar interface to users, but using internal functions. The release of gargle means these functions now exist in gargle, where they can be shared across packages, and the redundant versions in googledrive can be removed. The auth approach described here is already used in the (GitHub-only) <a href="https://googlesheets4.tidyverse.org">googlesheets4</a> package (the successor to <a href="https://github.com/jennybc/googlesheets">googlesheets</a>). Packages like <a href="https://bigrquery.r-dbi.org">bigrquery</a> and <a href="https://github.com/jimhester/gmailr">gmailr</a> are slated for retrofitting (these obviously require a thoughtful consideration of backwards compatibility).</p>
<div id="key-choices" class="section level2">
<h2 class="hasAnchor">
<a href="#key-choices" class="anchor"></a>Key choices</h2>
<p>Getting a token requires several pieces of information and there are stark differences in how much users (need to) know or control about this process. Let’s review them, with an eye towards identifying the responsibilities of the package author versus the user.</p>
<ul>
<li>Overall config: OAuth app and API key. Who provides?</li>
<li>Token-level properties: Google identity (email) and scopes.</li>
<li>Request-level: Who manages tokens and injects them into requests?</li>
</ul>
<div id="user-facing-auth" class="section level3">
<h3 class="hasAnchor">
<a href="#user-facing-auth" class="anchor"></a>User-facing auth</h3>
<p>In googledrive, the main user-facing auth function is <code>googledrive::drive_auth()</code>. Here is its definition (at least approximately, remember this is static code):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">drive_auth &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">email =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                       <span class="dt">path =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                       <span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">                       <span class="dt">cache =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oauth_cache</a></span>(),</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                       <span class="dt">use_oob =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oob_default</a></span>(),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">                       <span class="dt">token =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  cred &lt;-<span class="st"> </span>gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/token_fetch.html">token_fetch</a></span>(</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="dt">scopes =</span> scopes,</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="dt">app =</span> <span class="kw">drive_oauth_app</span>() <span class="op">%||%</span><span class="st"> </span>gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/internal-assets.html">tidyverse_app</a></span>(),</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="dt">email =</span> email,</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="dt">path =</span> path,</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="dt">package =</span> <span class="st">"googledrive"</span>,</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    <span class="dt">cache =</span> cache,</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    <span class="dt">use_oob =</span> use_oob,</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    <span class="dt">token =</span> token</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">  )</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">inherits</a></span>(cred, <span class="st">"Token2.0"</span>)) {</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    <span class="co"># throw an informative error here</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">  }</a>
<a class="sourceLine" id="cb1-21" data-line-number="21">  .auth<span class="op">$</span><span class="kw">set_cred</span>(cred)</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">  .auth<span class="op">$</span><span class="kw">set_auth_active</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb1-24" data-line-number="24">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/invisible">invisible</a></span>()</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">}</a></code></pre></div>
<p><code>drive_auth()</code> is called automatically upon the first need of a token and that can lead to user interaction, but does not necessarily do so. <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is described in the vignette <a href="https://gargle.r-lib.org/articles/how-gargle-gets-tokens.html">How gargle gets tokens</a>. The internal <code>.auth</code> object maintains googledrive’s auth state and is explained next.</p>
</div>
<div id="auth-state" class="section level3">
<h3 class="hasAnchor">
<a href="#auth-state" class="anchor"></a>Auth state</h3>
<p>A client package can use an internal object of class <code>gargle::AuthClass</code> to hold the auth state. Here’s how it is initialized in googledrive:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">.auth &lt;-<span class="st"> </span>gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/init_AuthState.html">init_AuthState</a></span>(</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">package     =</span> <span class="st">"googledrive"</span>,</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="dt">auth_active =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="co"># app = NULL,</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="co"># api_key = NULL,</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="co"># cred = NULL</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">)</a></code></pre></div>
<p>The Oauth <code>app</code> and <code>api_key</code> are configurable by the user and can fall back to internal credentials. The <code>cred</code> field is populated by the first call to <code>drive_auth()</code> (direct or indirectly via <code>drive_token()</code>).</p>
</div>
<div id="oauth-app" class="section level3">
<h3 class="hasAnchor">
<a href="#oauth-app" class="anchor"></a>OAuth app</h3>
<p>Most users should present OAuth user credentials to Google APIs. However, most users can also be spared the fiddly details surrounding this. The OAuth app is one example. The app is a component that most users do not even know about and they are content to use the same app for all work through a client package: possibly, the app built into the package.</p>
<p>There is a field in the <code>.auth</code> auth state to hold the OAuth <code>app</code>. Exported auth helpers, like <code>drive_oauth_app()</code> and <code>drive_auth_config()</code>, retrieve and modify the current app to support users ready to take that level of control.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googledrive)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">google_app &lt;-<span class="st"> </span>httr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/httr/topics/oauth_app">oauth_app</a></span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="st">"acme-corp"</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="dt">key =</span> <span class="st">"123456789.apps.googleusercontent.com"</span>,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="dt">secret =</span> <span class="st">"abcdefghijklmnopqrstuvwxyz"</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">drive_auth_config</span>(<span class="dt">app =</span> google_app)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">drive_oauth_app</span>()</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; &lt;oauth_app&gt; acme-corp</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt;   key:    123456789.apps.googleusercontent.com</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt;   secret: &lt;hidden&gt;</span></a></code></pre></div>
<p>Do not “borrow” an OAuth app (OAuth client ID and secret) from gargle or any other package; always use credentials associated with your package or provided by your user. Per the Google User Data Policy <a href="https://developers.google.com/terms/api-services-user-data-policy" class="uri">https://developers.google.com/terms/api-services-user-data-policy</a>, your application must accurately represent itself when authenticating to Google API services.</p>
</div>
<div id="api-key" class="section level3">
<h3 class="hasAnchor">
<a href="#api-key" class="anchor"></a>API key</h3>
<p>Some Google APIs can be used in an unauthenticated state, if and only if requests include an API key. For example, this is a great way to read a Google Sheet that is world-readable or readable by “anyone with a link” from a Shiny app, thereby designing away the need to manage user credentials on the server.</p>
<p>If you are wrapping an API with this feature, a default API key can be stored in the <code>api_key</code> field of the <code>.auth</code> auth state. As with the app, packages should obtain their own API key and not borrow the gargle or tidyverse key. And again, exported auth helpers, like <code>drive_api_key()</code> and <code>drive_auth_config()</code>, make the current key inspectable and configurable, for users ready to take that level of control.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googledrive)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">drive_auth_config</span>(<span class="dt">api_key =</span> <span class="st">"123456789"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">drive_api_key</span>()</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; "123456789"</span></a></code></pre></div>
</div>
<div id="email-or-google-identity" class="section level3">
<h3 class="hasAnchor">
<a href="#email-or-google-identity" class="anchor"></a>Email or Google identity</h3>
<p>In contrast to the OAuth app and API key, every user must express which identity they wish to present to the API. This is a familiar concept and users expect to specify this. Since users may have more than one Google account, it’s quite likely that they will want to switch between accounts, even within a single R session, or that they might want to explicitly declare the identity to be used in a specific script or app.</p>
<p>That explains why <code>drive_auth()</code> has the optional <code>email</code> argument that lets users proactively specify their identity. <code>drive_auth()</code> is usually called indirectly upon first need, but a user can also call it proactively in order to specify their target <code>email</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">drive_auth</span>(<span class="dt">email =</span> <span class="st">"janedoe_work@gmail.com"</span>)</a></code></pre></div>
<p>If <code>email</code> is not given, gargle also checks for an option named “gargle_oauth_email”. The <code>email</code> is used to look up tokens in the cache and, if no suitable token is found, it is used to pre-configure the OAuth chooser in the browser. Read more in the help for <code><a href="../reference/gargle_options.html">gargle::gargle_oauth_email()</a></code>.</p>
</div>
<div id="scopes" class="section level3">
<h3 class="hasAnchor">
<a href="#scopes" class="anchor"></a>Scopes</h3>
<p>Most users have no concept of scopes. They just know they want to work with, e.g., Google Drive or Google Sheets. A client package can usually pick sensible default scopes, that will support what most users want to do.</p>
<p>Here’s a reminder of the signature of <code>googledrive::drive_auth()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">drive_auth &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">email =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                       <span class="dt">path =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                       <span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">                       <span class="dt">cache =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oauth_cache</a></span>(),</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">                       <span class="dt">use_oob =</span> gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/gargle_options.html">gargle_oob_default</a></span>(),</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">                       <span class="dt">token =</span> <span class="ot">NULL</span>) { ... }</a></code></pre></div>
<p>googledrive ships with a default scope, but a motivated user could call <code>drive_auth()</code> pre-emptively at the start of the session and request different scopes. For example, if they intend to only read data and want to guard against inadvertent file modification, they might opt for the <code>drive.readonly</code> scope.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">drive_auth</span>(<span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/drive.readonly"</span>)</a></code></pre></div>
</div>
<div id="oauth-cache-and-out-of-bounds-auth" class="section level3">
<h3 class="hasAnchor">
<a href="#oauth-cache-and-out-of-bounds-auth" class="anchor"></a>OAuth cache and Out-of-bounds auth</h3>
<p>These are two aspects of OAuth where most users are content to go along with sensible default behaviour. For those who want to exert control, that can be done in direct calls to <code>drive_auth()</code> or by configuring an option. Read the help for <code><a href="../reference/gargle_options.html">gargle::gargle_oauth_cache()</a></code> and <code><a href="../reference/gargle_options.html">gargle::gargle_oob_default()</a></code> for more about these options.</p>
</div>
</div>
<div id="overview-of-mechanics" class="section level2">
<h2 class="hasAnchor">
<a href="#overview-of-mechanics" class="anchor"></a>Overview of mechanics</h2>
<p>Here’s a concrete outline of how one could set up a client package to get its auth functionality from gargle.</p>
<ol style="list-style-type: decimal">
<li>Add gargle to your package’s <code>Imports</code>.</li>
<li>Create a file <code>R/YOUR_PKG_auth.R</code>.</li>
<li>Create an internal <code>gargle::AuthClass</code> object to hold auth state. <code>R/YOUR_PKG_auth.R</code> is a good place to do this.</li>
<li>Define standard functions for the auth interface between gargle and your package; do this in <code>R/YOURPKG_auth.R</code>. Example: <a href="https://github.com/tidyverse/googledrive/blob/master/R/drive_auth.R"><code>tidyverse/googledrive/R/drive_auth.R</code></a>.</li>
<li>Use gargle’s roxygen helpers to create the docs for your auth functions. This relieves you from writing docs and you inherit standard wording. See <a href="https://github.com/tidyverse/googledrive/blob/master/R/drive_auth.R"><code>tidyverse/googledrive/R/drive_auth.R</code></a> for a demonstration.</li>
<li>Use the functions <code>YOURPKG_api_key()</code> and <code>YOURPKG_token()</code> (defined in the standard auth interface) to insert an API key or token in your package’s requests.</li>
</ol>
</div>
<div id="getting-that-first-token" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-that-first-token" class="anchor"></a>Getting that first token</h2>
<p>I focus on early use, by the naive user, with the OAuth flow. When the user first calls a high-level googledrive function such as <code>drive_find()</code>, a Drive request is ultimately generated with a call to <code>googledrive::request_generate()</code>. Here is its definition, at least approximately:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">request_generate &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">endpoint =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(),</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                             <span class="dt">params =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(),</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                             <span class="dt">key =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">                             <span class="dt">token =</span> <span class="kw">drive_token</span>()) {</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  ept &lt;-<span class="st"> </span>.endpoints[[endpoint]]</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(ept)) {</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    <span class="kw">stop_glue</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Endpoint not recognized:</span><span class="ch">\n</span><span class="st">  * {endpoint}"</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  }</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  ## modifications specific to googledrive package</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  params<span class="op">$</span>key &lt;-<span class="st"> </span>key <span class="op">%||%</span><span class="st"> </span>params<span class="op">$</span>key <span class="op">%||%</span><span class="st"> </span><span class="kw">drive_api_key</span>()</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(ept<span class="op">$</span>parameters<span class="op">$</span>supportsTeamDrives)) {</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    params<span class="op">$</span>supportsTeamDrives &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  }</a>
<a class="sourceLine" id="cb8-16" data-line-number="16"></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">  req &lt;-<span class="st"> </span>gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/request_develop.html">request_develop</a></span>(<span class="dt">endpoint =</span> ept, <span class="dt">params =</span> params)</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">  gargle<span class="op">::</span><span class="kw"><a href="https://gargle.r-lib.org/reference/request_develop.html">request_build</a></span>(</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">    <span class="dt">path =</span> req<span class="op">$</span>path,</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">    <span class="dt">method =</span> req<span class="op">$</span>method,</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">    <span class="dt">params =</span> req<span class="op">$</span>params,</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">    <span class="dt">body =</span> req<span class="op">$</span>body,</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">    <span class="dt">token =</span> token</a>
<a class="sourceLine" id="cb8-24" data-line-number="24">  )</a>
<a class="sourceLine" id="cb8-25" data-line-number="25">}</a></code></pre></div>
<p><code>googledrive::request_generate()</code> is a thin wrapper around <code><a href="../reference/request_develop.html">gargle::request_develop()</a></code> and <code><a href="../reference/request_develop.html">gargle::request_build()</a></code> that only implements details specific to googledrive, before delegating to more general functions in gargle. The vignette <a href="https://gargle.r-lib.org/articles/request-helper-functions.html">Request Helper Functions</a> documents these gargle functions.</p>
<p><code>googledrive::request_generate()</code> gets a token with <code>drive_token()</code>, which is defined like so:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">drive_token &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Logic">isFALSE</a></span>(.auth<span class="op">$</span>auth_active)) {</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  }</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="cf">if</span> (<span class="op">!</span><span class="kw">drive_has_token</span>()) {</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    <span class="kw">drive_auth</span>()</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  httr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/httr/topics/config">config</a></span>(<span class="dt">token =</span> .auth<span class="op">$</span>cred)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">}</a></code></pre></div>
<p>where <code>drive_has_token()</code> in a helper defined as:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># googledrive::</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">have_token &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">inherits</a></span>(.auth<span class="op">$</span>cred, <span class="st">"Token2.0"</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a></code></pre></div>
<p>By default, auth is active, and, for a fresh start, we won’t have a token stashed in <code>.auth</code> yet. So this will result in a call to <code>drive_auth()</code> to obtain a credential, which is then cached in <code>.auth$cred</code> for the remainder of the session. All subsequent calls to <code>drive_token()</code> will just spit back this token.</p>
<p>Above, we discussed scenarios where an advanced user might call <code>drive_auth()</code> proactively, with non-default arguments, possibly even loading a service token or using alternative flows, like Application Default Credentials or a Google Cloud Engine flow. Any token loaded in that way is stashed in <code>.auth$cred</code> and will be returned by subsequent calls to <code>drive_token()</code>.</p>
</div>
<div id="auth-interface" class="section level2">
<h2 class="hasAnchor">
<a href="#auth-interface" class="anchor"></a>Auth interface</h2>
<p>The exported functions like <code>drive_auth()</code>, <code>drive_token()</code>, etc. constitute the auth interface between googledrive and gargle and are centralized in <a href="https://github.com/tidyverse/googledrive/blob/master/R/drive_auth.R"><code>tidyverse/googledrive/R/drive_auth.R</code></a>. That is a good template for how to use gargle to manage auth in a client package. In addition, the docs for these gargle-backed functions are generated automatically from standard information maintained in the gargle package.</p>
<ul>
<li>
<code>drive_token()</code> retrieves the current credential, in a form that is ready for inclusion in HTTP requests. If <code>auth_active</code> is <code>TRUE</code> and <code>cred</code> is <code>NULL</code>, <code>drive_auth()</code> is called to obtain a credential. If <code>auth_active</code> is <code>FALSE</code>, <code>NULL</code> is returned; client packages should be designed to fall back to including an API key in affected HTTP requests.</li>
<li>
<code>drive_auth()</code> ensures we are dealing with an authenticated user and have a credential on hand with which to place authorized requests. Sets <code>auth_active</code> to <code>TRUE</code>. Can be called directly, but <code>drive_token()</code> will call when/as needed.</li>
<li>
<code>drive_deauth()</code> sets <code>auth_active</code> to <code>FALSE</code> and <code>.auth$cred</code> to <code>NULL</code>.</li>
<li>
<code>drive_oauth_app()</code> returns <code>.auth$app</code>.</li>
<li>
<code>drive_api_key()</code> returns <code>.auth$key</code>.</li>
<li>
<code>drive_auth_config()</code> can be used to query and set auth config. This is how an advanced user would enter their own OAuth app and API key into auth config, in order to affect all subsequent requests.</li>
</ul>
</div>
<div id="de-activating-auth" class="section level2">
<h2 class="hasAnchor">
<a href="#de-activating-auth" class="anchor"></a>De-activating auth</h2>
<p><code>drive_deauth()</code> can be used at any time to enter a de-authorized state, during which requests are sent out with an API key and no token. This is a great way to eliminate any friction re: auth if there’s no need for it, i.e. if all requests are for resources that are world readable or available to anyone who knows how to ask for it, such as files shared via “Anyone with the link”. The de-authorized state is especially useful in non-interactive settings or where user interaction is indirect, such as via Shiny.</p>
</div>
<div id="byoak-bring-your-own-app-and-key" class="section level2">
<h2 class="hasAnchor">
<a href="#byoak-bring-your-own-app-and-key" class="anchor"></a>BYOAK = Bring Your Own App and Key</h2>
<p>Advanced users can use their own OAuth app and API key. <code>drive_auth_config()</code> lives in <code>R/drive_auth()</code> and it provides the ability to see or modify the current <code>app</code> and <code>api_key</code>. Recall that <code>drive_oauth_app()</code> and <code>drive_api_key()</code> also exist for targeted, read-only access.</p>
</div>
<div id="changing-identities-and-more" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-identities-and-more" class="anchor"></a>Changing identities (and more)</h2>
<p>One reason for a user to call <code>drive_auth()</code> directly and proactively is to switch from one Google identity to another or to make sure they are presenting themselves with a specific identity. <code>drive_auth()</code> accepts an <code>email</code> argument, which is honored when gargle determines if there is already a suitable token on hand. Here is a sketch of how a user could switch identities during a session, possibly non-interactive:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(googledrive)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">drive_auth</span>(<span class="dt">email =</span> <span class="st">"janedoe_work@gmail.com"</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># do stuff with Google Drive here, with Jane Doe's "work" account</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw">drive_auth</span>(<span class="dt">email =</span> <span class="st">"janedoe_personal@gmail.com"</span>)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co"># do other stuff with Google Drive here, with Jane Doe's "personal" account</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">drive_auth</span>(<span class="dt">path =</span> <span class="st">"/path/to/a/service-account.json"</span>)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co"># do other stuff with Google Drive here, using a service account</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#key-choices">Key choices</a></li>
      <li><a href="#overview-of-mechanics">Overview of mechanics</a></li>
      <li><a href="#getting-that-first-token">Getting that first token</a></li>
      <li><a href="#auth-interface">Auth interface</a></li>
      <li><a href="#de-activating-auth">De-activating auth</a></li>
      <li><a href="#byoak-bring-your-own-app-and-key">BYOAK = Bring Your Own App and Key</a></li>
      <li><a href="#changing-identities-and-more">Changing identities (and more)</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://jennybryan.org">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
