<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to use gargle for auth in a client package • gargle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to use gargle for auth in a client package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gargle</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gargle-auth-in-client-package.html">How to use gargle for auth in a client package</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/gargle">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How to use gargle for auth in a client package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/master/vignettes/gargle-auth-in-client-package.Rmd"><code>vignettes/gargle-auth-in-client-package.Rmd</code></a></small>
      <div class="hidden name"><code>gargle-auth-in-client-package.Rmd</code></div>

    </div>

    
    
<p><em>In case it’s not obvious, this is very much a draft.</em></p>
<p>gargle provides common infrastructure for use with Google APIs. This vignette describes how a client package that provides high-level wrappers for a specific API could use gargle to deal with auth.</p>
<p>I refer to how this is done in the development version of <a href="https://googledrive.tidyverse.org">googledrive</a>, which is a functioning test bed.</p>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<ol style="list-style-type: decimal">
<li>Add gargle to your package’s <code>Imports</code>.</li>
<li>Create an internal <code>gargle::AuthClass</code> object to hold auth state, probably in <code>R/aaa.R</code>.</li>
<li>Define standard functions for the auth interface between gargle and your package, somewhere such as <code>R/YOURPKG_auth.R</code>. Example: <a href="https://github.com/tidyverse/googledrive/blob/master/R/drive_auth.R"><code>tidyverse/googledrive/R/drive_auth.R</code></a>
</li>
<li>Use the functions <code>YOURPKG_api_key()</code> and <code>YOURPKG_token()</code> (defined in the standard auth interface) to insert an API key or token in your package’s requests.</li>
<li>You or your user can take greater control of auth via <code>YOURPKG_auth_config()</code>, <code>YOURPKG_auth()</code>, and <code>YOURPKG_deauth()</code> (also defined in the standard auth interface).</li>
</ol>
</div>
<div id="initialize-package-auth-state" class="section level2">
<h2 class="hasAnchor">
<a href="#initialize-package-auth-state" class="anchor"></a>Initialize package auth state</h2>
<p>In <code>R/aaa.R</code>, create an internal object <code>.auth</code> to hold the auth state of your package. Here’s how that looks for googledrive:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">.auth &lt;-<span class="st"> </span>gargle<span class="op">::</span>AuthState<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="dt">package     =</span> <span class="st">"googledrive"</span>,</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="dt">app         =</span> gargle<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/gargle/topics/tidyverse_app">tidyverse_app</a></span>(),</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">api_key     =</span> gargle<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/gargle/topics/tidyverse_api_key">tidyverse_api_key</a></span>(),</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">auth_active =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="dt">cred        =</span> <span class="ot">NULL</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">)</a></code></pre></div>
<p>This state is initialized when googledrive is loaded and is updated during a user’s session. The <code>.auth</code> object lives in the googledrive namespace. It’s an instance of the <code>AuthState</code> R6 class provided by gargle.</p>
<p>Review of <code>.auth</code>’s fields:</p>
<ul>
<li>
<code>package</code>. It just seems like a good idea to record package name.</li>
<li>
<code>app</code>. The OAuth app. Most client packages will ship with a default app, for the sake of usability.
<ul>
<li>The googledrive package delegates back to a default tidyverse app provided by gargle. Only packages maintained within the <a href="https://github.com/tidyverse"><code>tidyverse</code></a> or <a href="https://github.com/r-lib"><code>r-lib</code></a> GitHub organizations should use this app.</li>
<li>Other packages should substitute their default app here.</li>
</ul>
</li>
<li>
<code>api_key</code>. An API key is necessary to send anonymous requests for public resources, i.e., it’s generally sent with requests that lack a token.
<ul>
<li>See description above of the <code>app</code> for reasons to ship with a working default and the appropriate usage of the tidyverse key.</li>
</ul>
</li>
<li>
<code>auth_active</code>. When <code>TRUE</code>, googledrive makes authorized requests on behalf of an authenticated user and sends a token. When <code>FALSE</code>, googledrive sends an API key and no token.</li>
<li>
<code>cred</code> holds the current credential.</li>
</ul>
</div>
<div id="getting-that-first-token" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-that-first-token" class="anchor"></a>Getting that first token</h2>
<p>I’m focusing on early use, by the naive user, with the OAuth flow. When the user first calls a high-level googledrive function such as <code>drive_find()</code>, a Drive request is ultimately generated with <code>googledrive::request_generate(..., key = NULL, token = drive_token())</code>.</p>
<p>In the body, the API key is set like so:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">params<span class="op">$</span>key &lt;-<span class="st"> </span>key <span class="op">%||%</span><span class="st"> </span>params<span class="op">$</span>key <span class="op">%||%</span><span class="st"> </span><span class="kw">drive_api_key</span>()</a></code></pre></div>
<p>The ability to pass the key directly or as a query parameter is only available to those using googledrive’s low-level API. This is not exposed in high-level functions, which, instead, can only access the current auth config. In this case, the key is obtained from the config via <code>drive_api_key()</code> but, ultimately, does not matter, since we’re going to get a token and we never send both.</p>
<p>Here’s the definition of <code>drive_token()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">drive_token &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Logic">isFALSE</a></span>(.auth<span class="op">$</span>auth_active)) {</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  }</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(.auth<span class="op">$</span>cred)) {</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="kw">drive_auth</span>()</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  httr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/httr/topics/config">config</a></span>(<span class="dt">token =</span> .auth<span class="op">$</span>cred)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">}</a></code></pre></div>
<p>By default, auth is active, so this will result in a call to <code>drive_auth()</code> to obtain a credential, which is then cached in <code>.auth$cred</code> for the remainder of the session.</p>
</div>
<div id="auth-interface" class="section level2">
<h2 class="hasAnchor">
<a href="#auth-interface" class="anchor"></a>Auth interface</h2>
<p>The exported functions like <code>drive_auth()</code>, <code>drive_token()</code>, etc. constitute the auth interface between googledrive and gargle and are centralized in <a href="https://github.com/tidyverse/googledrive/blob/master/R/drive_auth.R"><code>tidyverse/googledrive/R/drive_auth.R</code></a>. That is a good template for how to use gargle to manage auth in a client package. In addition, the docs for these gargle-backed functions are generated automatically from standard information maintained in the gargle package.</p>
<ul>
<li>
<code>drive_token()</code> retrieves the current credential, in a form that is ready for inclusion in HTTP requests. If <code>auth_active</code> is <code>TRUE</code> and <code>cred</code> is <code>NULL</code>, <code>drive_auth()</code> is called to obtain a credential. If <code>auth_active</code> is <code>FALSE</code>, <code>NULL</code> is returned; client packages should be designed to fall back to including an API key in affected HTTP requests.</li>
<li>
<code>drive_auth()</code> ensures we are dealing with an authenticated user and have a credential on hand with which to place authorized requests. Sets <code>auth_active</code> to <code>TRUE</code>. Can be called directly, but <code>drive_token()</code> will call when/as needed.</li>
<li>
<code>drive_deauth()</code> sets <code>auth_active</code> to <code>FALSE</code>.</li>
<li>
<code>drive_oauth_app()</code> returns <code>.auth$app</code>.</li>
<li>
<code>drive_api_key()</code> returns <code>.auth$key</code>.</li>
<li>
<code>drive_auth_config()</code> can be used to query and set auth config. This is how an advanced user would enter their own OAuth app and API key into auth config, in order to affect all subsequent requests.</li>
</ul>
</div>
<div id="de-activating-auth" class="section level2">
<h2 class="hasAnchor">
<a href="#de-activating-auth" class="anchor"></a>De-activating auth</h2>
<p><code>drive_deauth()</code> can be used at any time to enter a de-authorized state, during which requests are sent out with an API key and no token. This is a great way to eliminate any friction re: auth if there’s no need for it, i.e. if all requests are for resources that are world readable or available to anyone who knows how to ask for it, such as files shared via “Anyone with the link”. The de-authorized state is especially useful in non-interactive settings or where user interaction is indirect, such as via Shiny.</p>
</div>
<div id="byoak-bring-your-own-app-and-key" class="section level2">
<h2 class="hasAnchor">
<a href="#byoak-bring-your-own-app-and-key" class="anchor"></a>BYOAK = Bring Your Own App and Key</h2>
<p>Advanced users can use their own OAuth app and API key. <code>drive_auth_config()</code> lives in <code>R/drive_auth()</code> and it provides the ability to see or modify the current <code>app</code> and <code>api_key</code>. Recall that <code>drive_oauth_app()</code> and <code>drive_api_key()</code> also exist for targeted, read-only access.</p>
</div>
<div id="changing-identities-and-more" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-identities-and-more" class="anchor"></a>Changing identities (and more)</h2>
<p>One reason for a user to call <code>drive_auth()</code> directly and proactively is to switch from one Google identity to another or to make sure they are presenting themselves with a specific identity. <code>drive_auth()</code> accepts an <code>email</code> argument, which is honored when gargle determines if there is already a suitable token on hand.</p>
<p><code>drive_auth()</code> gives the motivated user more control:</p>
<ul>
<li>
<code>email</code>: Specify a Google identity.</li>
<li>
<code>path</code>: Provide a service account token.</li>
<li>
<code>scopes</code>: Request, for example, a narrower scope that is read-only.</li>
<li>
<code>cache</code>: Control whether gargle uses a token cache.</li>
<li>
<code>use_oob</code>: Toggle out-of-band authentication.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#initialize-package-auth-state">Initialize package auth state</a></li>
      <li><a href="#getting-that-first-token">Getting that first token</a></li>
      <li><a href="#auth-interface">Auth interface</a></li>
      <li><a href="#de-activating-auth">De-activating auth</a></li>
      <li><a href="#byoak-bring-your-own-app-and-key">BYOAK = Bring Your Own App and Key</a></li>
      <li><a href="#changing-identities-and-more">Changing identities (and more)</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://jennybryan.org">Jennifer Bryan</a>, Craig Citro, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
